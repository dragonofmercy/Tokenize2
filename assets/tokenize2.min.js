/*!
 * Tokenize2 v0.1-beta (https://github.com/zellerda/Tokenize2)
 * Copyright 2016 David Zeller.
 * Licensed under the new BSD license
 */
!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&module.exports?module.exports=function(e,o){return void 0===o&&(o="undefined"!=typeof window?require("jquery"):require("jquery")(e)),t(o),o}:t(jQuery)}(function(t){function e(e){return this.filter("select").each(function(){var i=t(this),n=i.data("tokenize2"),s="object"==typeof e&&e;n||i.data("tokenize2",new o(this,s))})}var o=function(e,i){this.control=!1,this.element=t(e),this.options=t.extend({},o.DEFAULTS,i),this.options.tabIndex=-1===this.options.tabIndex?0:this.options.tabIndex,this.options.sortable=1===this.options.tokensMaxItems?!1:this.options.sortable,this.bind(),this.trigger("tokenize:load")},i={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,ARROW_UP:38,ARROW_DOWN:40,CTRL:17,MAJ:16};o.VERSION="0.1-beta",o.DEBOUNCE=null,o.DEFAULTS={tokensMaxItems:0,tokensAllowCustom:!1,dropdownMaxItems:10,searchMinLength:0,searchFromStart:!0,searchHighlight:!0,delimiter:",",dataSource:"select",debounce:0,placeholder:!1,sortable:!1,tabIndex:0},o.prototype.trigger=function(t,e,o,i){this.element.trigger(t,e,o,i)},o.prototype.bind=function(){this.element.on("tokenize:load",{},t.proxy(function(){this.init()},this)).on("tokenize:clear",{},t.proxy(function(){this.clear()},this)).on("tokenize:remap",{},t.proxy(function(){this.remap()},this)).on("tokenize:select",{},t.proxy(function(t,e){this.focus(e)},this)).on("tokenize:deselect",{},t.proxy(function(){this.blur()},this)).on("tokenize:search",{},t.proxy(function(t,e){this.find(e)},this)).on("tokenize:paste",{},t.proxy(function(){this.paste()},this)).on("tokenize:dropdown:up",{},t.proxy(function(){this.dropdownSelectionMove(-1)},this)).on("tokenize:dropdown:down",{},t.proxy(function(){this.dropdownSelectionMove(1)},this)).on("tokenize:dropdown:clear",{},t.proxy(function(){this.dropdownClear()},this)).on("tokenize:dropdown:show",{},t.proxy(function(){this.dropdownShow()},this)).on("tokenize:dropdown:hide",{},t.proxy(function(){this.dropdownHide()},this)).on("tokenize:dropdown:fill",{},t.proxy(function(t,e){this.dropdownFill(e)},this)).on("tokenize:dropdown:itemAdd",{},t.proxy(function(t,e){this.dropdownAddItem(e)},this)).on("tokenize:keypress",{},t.proxy(function(t,e){this.keypress(e)},this)).on("tokenize:keydown",{},t.proxy(function(t,e){this.keydown(e)},this)).on("tokenize:keyup",{},t.proxy(function(t,e){this.keyup(e)},this)).on("tokenize:tokens:reorder",{},t.proxy(function(){this.reorder()},this)).on("tokenize:tokens:add",{},t.proxy(function(t,e,o,i){this.tokenAdd(e,o,i)},this)).on("tokenize:tokens:remove",{},t.proxy(function(t,e){this.tokenRemove(e)},this))},o.prototype.init=function(){this.id=this.guid(),this.element.hide(),this.element.attr("multiple")||console.error("Attribute multiple is missing, tokenize2 can be buggy !"),this.dropdown=void 0,this.searchContainer=t('<li class="token-search" />'),this.input=t('<input autocomplete="off" />').on("keydown",{},t.proxy(function(t){this.trigger("tokenize:keydown",[t])},this)).on("keypress",{},t.proxy(function(t){this.trigger("tokenize:keypress",[t])},this)).on("keyup",{},t.proxy(function(t){this.trigger("tokenize:keyup",[t])},this)).on("focus",{},t.proxy(function(){this.input.val().length>0&&this.trigger("tokenize:search",[this.input.val()])},this)).on("paste",{},t.proxy(function(){this.options.tokensAllowCustom&&setTimeout(t.proxy(function(){this.trigger("tokenize:paste")},this),10)},this)),this.tokensContainer=t('<ul class="tokens-container form-control" />').addClass(this.element.attr("data-class")).attr("tabindex",this.options.tabIndex).append(this.searchContainer.append(this.input)),this.options.placeholder!==!1&&(this.placeholder=t('<li class="placeholder" />').html(this.options.placeholder),this.tokensContainer.prepend(this.placeholder),this.element.on("tokenize:remap tokenize:select tokenize:deselect tokenize:tokens:remove",t.proxy(function(){this.container.hasClass("focus")||t("li.token",this.tokensContainer).length>0||this.input.val().length>0?this.placeholder.hide():this.placeholder.show()},this))),this.container=t('<div class="tokenize" />').attr("id",this.id),this.container.append(this.tokensContainer).insertAfter(this.element),this.container.focusin(t.proxy(function(e){this.trigger("tokenize:select",[t(e.target)[0]==this.tokensContainer[0]])},this)).focusout(t.proxy(function(){this.trigger("tokenize:deselect")},this)),1===this.options.tokensMaxItems&&this.container.addClass("single"),this.options.sortable&&("undefined"!=typeof t.ui?(this.container.addClass("sortable"),this.tokensContainer.sortable({items:"li.token",cursor:"move",placeholder:"token shadow",forcePlaceholderSize:!0,update:t.proxy(function(){this.trigger("tokenize:tokens:reorder")},this),start:t.proxy(function(){this.searchContainer.hide()},this),stop:t.proxy(function(){this.searchContainer.show()},this)})):(this.options.sortable=!1,console.error("jQuery UI is not loaded, sortable option has been disabled"))),this.element.on("tokenize:tokens:add tokenize:tokens:remove",t.proxy(function(){this.options.tokensMaxItems>0&&t("li.token",this.tokensContainer).length>=this.options.tokensMaxItems?this.searchContainer.hide():this.searchContainer.show()},this)).on("tokenize:keydown tokenize:keyup tokenize:loaded",t.proxy(function(){this.scaleInput()},this)),this.trigger("tokenize:remap"),this.trigger("tokenize:tokens:reorder"),this.trigger("tokenize:loaded")},o.prototype.reorder=function(){if(this.options.sortable){var e,o;t.each(this.tokensContainer.sortable("toArray",{attribute:"data-value"}),t.proxy(function(i,n){o=t('option[value="'+n+'"]',this.element),void 0==e?o.prependTo(this.element):e.after(o),e=o},this))}},o.prototype.paste=function(){var e=new RegExp(this.escapeRegex(Array.isArray(this.options.delimiter)?this.options.delimiter.join("|"):this.options.delimiter),"ig");e.test(this.input.val())&&t.each(this.input.val().split(e),t.proxy(function(t,e){this.trigger("tokenize:tokens:add",[e,null,!0])},this))},o.prototype.tokenAdd=function(e,o,i){if(e=this.escape(e),o=o||e,i=i||!1,this.resetInput(),void 0===e||""===e)return this.trigger("tokenize:tokens:error:empty"),this;if(this.options.tokensMaxItems>0&&t("li.token",this.tokensContainer).length>=this.options.tokensMaxItems)return this.trigger("tokenize:tokens:error:max"),this;if(t('li.token[data-value="'+e+'"]',this.tokensContainer).length>0)return this.trigger("tokenize:tokens:error:duplicate",[e,o]),this;if(t('option[value="'+e+'"]',this.element).length)t('option[value="'+e+'"]',this.element).attr("selected","selected").prop("selected",!0);else if(i)this.element.append(t("<option selected />").val(e).html(o));else{if(!this.options.tokensAllowCustom)return this.trigger("tokenize:tokens:error:notokensAllowCustom"),this;this.element.append(t('<option selected data-type="custom" />').val(e).html(o))}return t('<li class="token" />').attr("data-value",e).append("<span>"+o+"</span>").prepend(t('<a class="dismiss" />').html("&#215;").on("mousedown touchstart",{},t.proxy(function(t){t.preventDefault(),this.trigger("tokenize:tokens:remove",[e])},this))).insertBefore(this.searchContainer),this.trigger("tokenize:dropdown:hide"),this},o.prototype.tokenRemove=function(e){var o=t('option[value="'+e+'"]',this.element);return"custom"===o.attr("data-type")?o.remove():o.removeAttr("selected").prop("selected",!1),t('li.token[data-value="'+e+'"]',this.tokensContainer).remove(),this.trigger("tokenize:tokens:reorder"),this},o.prototype.remap=function(){var e=t("option:selected",this.element);return e.each(t.proxy(function(e,o){this.trigger("tokenize:tokens:add",[t(o).val(),t(o).html(),!1])},this)),this},o.prototype.focus=function(t){t&&this.input.focus(),this.container.addClass("focus")},o.prototype.blur=function(){this.isDropdownOpen()&&this.trigger("tokenize:dropdown:hide"),this.container.removeClass("focus"),this.resetPending()},o.prototype.keydown=function(e){if("keydown"===e.type)switch(e.keyCode){case i.BACKSPACE:if(this.input.val().length<1){if(e.preventDefault(),t("li.token.pending-delete",this.tokensContainer).length>0)this.trigger("tokenize:tokens:remove",[t("li.token.pending-delete",this.tokensContainer).first().attr("data-value")]);else{var o=t("li.token:last",this.tokensContainer);o.length>0&&(this.trigger("tokenize:tokens:markForDelete",[o.attr("data-value")]),o.addClass("pending-delete"))}this.trigger("tokenize:dropdown:hide")}break;case i.TAB:case i.ENTER:this.pressedDelimiter(e);break;case i.ESCAPE:this.resetPending();break;case i.ARROW_UP:e.preventDefault(),this.trigger("tokenize:dropdown:up");break;case i.ARROW_DOWN:e.preventDefault(),this.trigger("tokenize:dropdown:down");break;case i.CTRL:this.control=!0;break;default:this.resetPending()}else e.preventDefault()},o.prototype.keyup=function(t){if("keyup"===t.type)switch(t.keyCode){case i.TAB:case i.ENTER:case i.ESCAPE:case i.ARROW_UP:case i.ARROW_DOWN:case i.MAJ:break;case i.CTRL:this.control=!1;break;case i.BACKSPACE:default:this.input.val().length>0?this.trigger("tokenize:search",[this.input.val()]):this.trigger("tokenize:dropdown:hide")}else t.preventDefault()},o.prototype.keypress=function(t){if("keypress"===t.type){var e=!1;Array.isArray(this.options.delimiter)?this.options.delimiter.indexOf(String.fromCharCode(t.which))>=0&&(e=!0):String.fromCharCode(t.which)==this.options.delimiter&&(e=!0),e&&this.pressedDelimiter(t)}else t.preventDefault()},o.prototype.pressedDelimiter=function(e){this.resetPending(),e.preventDefault(),this.isDropdownOpen()&&t("li.active",this.dropdown).length>0&&this.control===!1?t("li.active a",this.dropdown).trigger("mousedown"):this.input.val().length>0&&this.trigger("tokenize:tokens:add",[this.input.val()])},o.prototype.find=function(t){return t.length<this.options.searchMinLength?(this.trigger("tokenize:dropdown:hide"),!1):(this.lastSearchTerms=t,void("select"===this.options.dataSource?this.dataSourceLocal(t):"function"==typeof this.options.dataSource?this.options.dataSource(t):this.dataSourceRemote(t)))},o.prototype.dataSourceRemote=function(e){this.debounce(t.proxy(function(){void 0!==this.xhr&&this.xhr.abort(),this.xhr=t.ajax(this.options.dataSource,{data:{search:e},dataType:"json",success:t.proxy(function(e){var o=[];t.each(e,t.proxy(function(t,e){o.push(e)},this)),this.trigger("tokenize:dropdown:fill",[o])},this)})},this),this.options.debounce)},o.prototype.dataSourceLocal=function(e){var o=[],i=(this.options.searchFromStart?"^":"")+this.escapeRegex(e),n=new RegExp(i,"i");t("option",this.element).not(":selected, :disabled").each(function(){n.test(t(this).html())&&o.push({value:t(this).attr("value"),text:t(this).html()})}),this.trigger("tokenize:dropdown:fill",[o])},o.prototype.debounce=function(e,o){var i=arguments,n=t.proxy(function(){e.apply(this,i),this.debounceTimeout=void 0},this);void 0!==this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(n,o||0)},o.prototype.dropdownShow=function(){this.isDropdownOpen()||(t(".tokenize-dropdown").remove(),this.dropdown=t('<div class="tokenize-dropdown dropdown"><ul class="dropdown-menu" /></div>').attr("data-related",this.id),t("body").append(this.dropdown.show()),t(window).on("resize scroll",{},t.proxy(function(){this.dropdownMove()},this)).trigger("resize"),this.trigger("tokenize:dropdown:shown"))},o.prototype.dropdownHide=function(){this.isDropdownOpen()&&(t(window).off("resize"),this.dropdown.remove(),this.dropdown=void 0,this.trigger("tokenize:dropdown:hidden"))},o.prototype.dropdownClear=function(){this.dropdown.find(".dropdown-menu li").remove()},o.prototype.dropdownFill=function(e){e&&e.length>0?(this.trigger("tokenize:dropdown:show"),this.trigger("tokenize:dropdown:clear"),t.each(e,t.proxy(function(e,o){t("li.dropdown-item",this.dropdown).length<=this.options.dropdownMaxItems&&this.trigger("tokenize:dropdown:itemAdd",[o])},this)),t("li.active",this.dropdown).length<1&&t("li:first",this.dropdown).addClass("active"),t("li.dropdown-item",this.dropdown).length<1?this.trigger("tokenize:dropdown:hide"):this.trigger("tokenize:dropdown:filled")):this.trigger("tokenize:dropdown:hide"),t(window).trigger("resize")},o.prototype.dropdownSelectionMove=function(e){if(t("li.active",this.dropdown).length>0)if(t("li.active",this.dropdown).is("li:"+(e>0?"last-child":"first-child")))t("li.active",this.dropdown).removeClass("active"),t("li:"+(e>0?"first-child":"last-child"),this.dropdown).addClass("active");else{var o=t("li.active",this.dropdown);o.removeClass("active"),e>0?o.next().addClass("active"):o.prev().addClass("active")}else t("li:first",this.dropdown).addClass("active")},o.prototype.dropdownAddItem=function(e){if(this.isDropdownOpen()){var o=t('<li class="dropdown-item" />').html(this.dropdownItemFormat(e)).on("mouseover",t.proxy(function(e){t("li",this.dropdown).removeClass("active"),t(e.target).parent().addClass("active")},this)).on("mouseout",t.proxy(function(){t("li",this.dropdown).removeClass("active")},this)).on("mousedown touchstart",t.proxy(function(e){e.preventDefault(),this.trigger("tokenize:tokens:add",[t(e.target).attr("data-value"),t(e.target).attr("data-text"),!0])},this));t('li.token[data-value="'+o.find("a").attr("data-value")+'"]',this.tokensContainer).length<1&&(this.dropdown.find(".dropdown-menu").append(o),this.trigger("tokenize:dropdown:itemAdded",[e]))}},o.prototype.dropdownItemFormat=function(e){var o=new RegExp((this.options.searchFromStart?"^":"")+"("+this.escapeRegex(this.lastSearchTerms)+")","gi"),i=e.text.replace(o,'<span class="tokenize-highlight">$1</span>');return t("<a />").html(i).attr({"data-value":e.value,"data-text":e.text})},o.prototype.dropdownMove=function(){var e=this.tokensContainer.offset(),o=this.tokensContainer.outerHeight(),i=this.tokensContainer.outerWidth();this.dropdown.css({top:e.top+o,left:e.left-t(window).scrollLeft(),width:i})},o.prototype.isDropdownOpen=function(){return void 0!==this.dropdown},o.prototype.clear=function(){return t.each(t("li.token",this.tokensContainer),t.proxy(function(e,o){this.trigger("tokenize:tokens:remove",[t(o).attr("data-value")])},this)),this.trigger("tokenize:dropdown:hide"),this},o.prototype.resetPending=function(){var e=t("li.pending-delete:last",this.tokensContainer);e.length>0&&(this.trigger("tokenize:tokens:cancelDelete",[e.attr("data-value")]),e.removeClass("pending-delete"))},o.prototype.scaleInput=function(){var t,e,o=document.createElement("canvas"),i=o.getContext("2d");i.font=this.input.css("font-style")+" "+this.input.css("font-variant")+" "+this.input.css("font-weight")+" "+Math.ceil(parseFloat(this.input.css("font-size")))+"px "+this.input.css("font-family"),t=Math.round(i.measureText(this.input.val()+"M").width)+Math.ceil(parseFloat(this.searchContainer.css("margin-left")))+Math.ceil(parseFloat(this.searchContainer.css("margin-right"))),e=this.tokensContainer.width()-(Math.ceil(parseFloat(this.tokensContainer.css("border-left-width")))+Math.ceil(parseFloat(this.tokensContainer.css("border-right-width"))+Math.ceil(parseFloat(this.tokensContainer.css("padding-left")))+Math.ceil(parseFloat(this.tokensContainer.css("padding-right"))))),t>=e&&(t=e),this.searchContainer.width(t),o.remove()},o.prototype.resetInput=function(){this.input.val(""),this.scaleInput()},o.prototype.escape=function(t){var e=document.createElement("div");return e.innerHTML=t,t=e.textContent||e.innerText||"",String(t).replace(/["]/g,function(){return'"'})},o.prototype.escapeRegex=function(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")},o.prototype.guid=function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},o.prototype.toArray=function(){var e=[];return t("option:selected",this.element).each(function(){e.push(t(this).val())}),e};var n=t.fn.tokenize2;t.fn.tokenize2=e,t.fn.tokenize2.Constructor=o,t.fn.tokenize2.noConflict=function(){return t.fn.tokenize2=n,this}});